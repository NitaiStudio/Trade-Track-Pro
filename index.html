<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TradeTrack Pro | Nitai Studio</title>

    <!-- Google Material Icons & Plus Jakarta Font -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #000000;
            --surface: rgba(255, 255, 255, 0.05);
            --primary: #d0bcff;
            --secondary: #b0a1cf;
            --neon-blue: #00f2ff;
            --neon-purple: #9d00ff;
            --error: #ff5252;
            --success: #00e676;
            --text: #ffffff;
            --text-dim: #999999;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body, html {
            margin: 0; padding: 0;
            background-color: #050505;
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- Application Container (Mobile & Windows Compatible) --- */
        .app-shell {
            width: 100%;
            height: 100%;
            max-width: 480px;
            background: radial-gradient(circle at top right, #151515, #000);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        @media screen and (min-width: 600px) {
            .app-shell {
                height: 92vh;
                border-radius: 40px;
                border: 2px solid var(--border);
                box-shadow: 0 0 50px rgba(208, 188, 255, 0.1);
            }
        }

        /* --- Scrollable Content Area --- */
        .content-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 120px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .content-container::-webkit-scrollbar { display: none; }

        /* --- Splash Screen Unique Animation --- */
        #splash {
            position: absolute; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .logo-neon {
            width: 110px; height: 110px; background: #111; border-radius: 35px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--primary);
            box-shadow: 0 0 20px var(--primary);
            animation: pulse-neon 2.5s infinite;
        }
        @keyframes pulse-neon {
            0% { transform: scale(1); box-shadow: 0 0 10px var(--primary); }
            50% { transform: scale(1.08); box-shadow: 0 0 40px var(--primary); }
            100% { transform: scale(1); box-shadow: 0 0 10px var(--primary); }
        }

        /* --- Neon Glass Cards --- */
        .neon-card {
            background: var(--surface);
            backdrop-filter: blur(25px);
            border-radius: 30px; padding: 25px; margin: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slide-up 0.5s ease;
        }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .btn-premium {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #000; border: none; padding: 18px; border-radius: 20px;
            font-weight: 800; cursor: pointer; width: 100%; display: flex;
            align-items: center; justify-content: center; gap: 10px; font-size: 15px;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
        }
        .btn-premium:active { transform: scale(0.96); }

        input, select, textarea {
            width: 100%; background: rgba(255,255,255,0.06); border: 1px solid var(--border);
            padding: 16px; border-radius: 18px; color: #fff; margin-bottom: 8px; font-size: 16px;
        }
        input:focus { border-color: var(--neon-blue); outline: none; }

        label { display: block; font-size: 12px; color: var(--primary); margin: 12px 0 6px 8px; font-weight: 800; text-transform: uppercase; }

        /* --- Floating Navigation --- */
        nav {
            position: absolute; bottom: 25px; left: 15px; right: 15px; height: 80px;
            background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(30px);
            display: flex; justify-content: space-around; align-items: center;
            border-radius: 28px; border: 1px solid var(--border); z-index: 999;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
        }
        .nav-item { 
            background: none; border: none; color: var(--text-dim); 
            display: flex; flex-direction: column; align-items: center; 
            cursor: pointer; font-size: 10px; font-weight: 800; flex: 1;
        }
        .nav-item.active { color: var(--neon-blue); }
        .nav-item i { font-size: 30px; margin-bottom: 2px; transition: 0.3s; }
        .nav-item.active i { transform: translateY(-5px) scale(1.1); text-shadow: 0 0 15px var(--neon-blue); }

        /* --- Screens & Overlays --- */
        .screen { display: none; }
        .screen.active { display: block; }
        .overlay { position: absolute; inset: 0; background: #000; z-index: 2000; padding: 25px; display: flex; align-items: center; justify-content: center; }
        .modal { background: #0a0a0a; padding: 35px; border-radius: 45px; width: 100%; border: 1px solid var(--border); text-align: center; }

        .hidden { display: none !important; }

        /* --- Stats Layout --- */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 15px; }
        .stat-box { background: rgba(255,255,255,0.03); padding: 22px; border-radius: 30px; border: 1px solid var(--border); }

        .log-item { background: rgba(255,255,255,0.02); border-radius: 25px; padding: 20px; margin: 10px 15px; border-left: 6px solid #222; }

        /* Support Buttons */
        .support-link { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 15px; border-radius: 18px; background: #111; border: 1px solid var(--border); text-decoration: none; color: #fff; font-size: 12px; font-weight: 800; margin-top: 10px; }

        header { padding: 45px 25px 15px 25px; }
        h1 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
    </style>
</head>
<body>

    <div class="app-shell">
        <!-- 1. Unique Animated Splash -->
        <div id="splash">
            <div class="logo-neon">
                <i class="material-icons-round" style="font-size: 65px; color: var(--primary);">trending_up</i>
            </div>
            <h2 style="margin:25px 0 5px 0; letter-spacing: 1px;">TradeTrack Pro</h2>
            <p style="color: var(--primary); font-weight: 700; letter-spacing: 2px; font-size: 12px;">NITAI STUDIO</p>
        </div>

        <!-- 2. Integrated Login Overlay -->
        <div id="login-overlay" class="overlay hidden">
            <div class="modal">
                <div class="logo-neon" style="width:70px; height:70px; margin: 0 auto 20px auto; border-radius: 20px;">
                    <i class="material-icons-round">vpn_key</i>
                </div>
                <h2 style="margin:0 0 10px 0">Login</h2>
                <label>Choose Language</label>
                <select id="app-lang" onchange="app.updateLanguage()">
                    <option value="en">English (Global)</option>
                    <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (India/BD)</option>
                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (India)</option>
                </select>
                <label>Mobile Number</label>
                <input type="tel" id="user-mobile" placeholder="9876543210">
                <button class="btn-premium" style="margin-top:20px;" onclick="app.doLogin()">Confirm Account</button>
            </div>
        </div>

        <!-- 3. Mandatory Policy Notice -->
        <div id="notice-overlay" class="overlay hidden">
            <div class="modal">
                <h2 style="color:var(--error); margin-top:0">POLICY NOTICE</h2>
                <div style="max-height: 50vh; overflow-y: auto; text-align: left; padding: 10px;">
                    <p id="l-notice-text" style="font-size: 14px; line-height: 1.8; color: var(--text-dim);"></p>
                </div>
                <button class="btn-premium" style="margin-top:20px;" onclick="app.acceptNotice()">I UNDERSTAND & AGREE</button>
            </div>
        </div>

        <!-- 4. Main App Interface -->
        <div class="content-container" id="main-content" style="display:none;">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1 id="screen-title">Dashboard</h1>
                    <div style="width: 50px; height: 50px; background: var(--surface); border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border);" onclick="app.navigate('info')">
                        <i class="material-icons-round" style="color: var(--primary)">person</i>
                    </div>
                </div>
                <div id="user-id-tag" style="font-size: 11px; color: var(--neon-blue); font-weight: 800; margin-top: 8px;"></div>
            </header>

            <!-- Screen: Home Dash -->
            <div id="scr-dash" class="screen">
                <div class="stat-grid">
                    <div class="stat-box" style="border-bottom: 3px solid var(--neon-blue);">
                        <small id="l-win-rate" style="color: var(--text-dim); font-size: 9px; font-weight: 800;">WIN RATE</small>
                        <div style="font-size: 26px; font-weight: 800; color: var(--neon-blue); margin-top: 5px;" id="d-win">0%</div>
                    </div>
                    <div class="stat-box" style="border-bottom: 3px solid var(--primary);">
                        <small id="l-avg-rr" style="color: var(--text-dim); font-size: 9px; font-weight: 800;">AVG RR</small>
                        <div style="font-size: 26px; font-weight: 800; margin-top: 5px;" id="d-rr">0.00</div>
                    </div>
                </div>
                <div class="stat-grid" style="margin-top: 15px;">
                    <div class="stat-box">
                        <small id="l-total-inv" style="color: var(--text-dim); font-size: 9px;">INVESTED</small>
                        <div style="font-size: 20px; font-weight: 800; margin-top: 5px;" id="d-inv">‚Çπ0</div>
                    </div>
                    <div class="stat-box" style="border-bottom-color: var(--error);">
                        <small id="l-net-pnl" style="color: var(--text-dim); font-size: 9px;">NET P/L</small>
                        <div style="font-size: 20px; font-weight: 800; margin-top: 5px;" id="d-pnl">‚Çπ0</div>
                    </div>
                </div>
                <div style="padding: 30px 25px 10px 25px;"><h3 id="l-recent-head" style="margin:0; font-size: 18px;">Recent Journal Logs</h3></div>
                <div id="list-recent"></div>
            </div>

            <!-- Screen: Add Journal Entry -->
            <div id="scr-add" class="screen">
                <div class="neon-card">
                    <label id="l-date">Date</label>
                    <input type="date" id="t-date">
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                        <div>
                            <label id="l-session">Session</label>
                            <select id="t-session">
                                <option value="London">London üá¨üáß</option>
                                <option value="NY">New York üá∫üá∏</option>
                                <option value="Asia">Asia üáØüáµ</option>
                                <option value="India">India üáÆüá≥</option>
                            </select>
                        </div>
                        <div>
                            <label id="l-logic">Strategy</label>
                            <select id="t-logic">
                                <option value="Breakout">Breakout</option>
                                <option value="Trend">Trend Follow</option>
                                <option value="S/R">Supp/Resist</option>
                            </select>
                        </div>
                    </div>

                    <label id="l-symbol">Asset Name</label>
                    <input type="text" id="t-symbol" placeholder="BTC, NIFTY, GOLD">

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                        <div><label id="l-rr">R:R Ratio</label><input type="number" step="0.1" id="t-rr" placeholder="1.5"></div>
                        <div>
                            <label id="l-outcome">Trade Result</label>
                            <select id="t-outcome">
                                <option value="Win">PROFIT (Win)</option>
                                <option value="Loss">LOSS (Loss)</option>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                        <div><label id="l-bq">Buy Price</label><input type="number" id="t-bq" placeholder="0"></div>
                        <div><label id="l-sq">Sell Price</label><input type="number" id="t-sq" placeholder="0"></div>
                    </div>

                    <label id="l-mistake">Notes / Logic</label>
                    <textarea id="t-mistake" rows="3" placeholder="What happened in this trade?"></textarea>

                    <button class="btn-premium" style="margin-top:20px" onclick="app.saveEntry()" id="l-save-btn">Save Journal</button>
                </div>
            </div>

            <!-- Screen: History Logs -->
            <div id="scr-history" class="screen">
                <div id="list-history"></div>
            </div>

            <!-- Screen: Nitai Studio Support -->
            <div id="scr-info" class="screen">
                <div class="neon-card" style="text-align: center;">
                    <div class="logo-neon" style="width: 80px; height: 80px; margin: 0 auto 20px auto; border-radius: 20px;">
                        <i class="material-icons-round" style="font-size: 50px;">person</i>
                    </div>
                    <h2 style="margin: 0; color: var(--primary);">NITAI STUDIO</h2>
                    <p style="font-size: 13px; color: var(--text-dim);">Global Trading Tracker Tool</p>
                    
                    <div style="margin: 25px 0;">
                        <p style="font-size: 11px; font-weight: 800; color: var(--neon-blue); text-transform: uppercase;">Support the Dev</p>
                        <a href="https://buymeacoffee.com/nitaigrp00a" class="support-link"><i class="material-icons-round">coffee</i> Buy Me a Coffee</a>
                        <a href="https://ko-fi.com/nitaisarkar" class="support-link"><i class="material-icons-round">favorite</i> Ko-fi Support</a>
                        <a href="https://www.patreon.com/cw/NitaiStudio" class="support-link"><i class="material-icons-round">stars</i> Patreon Support</a>
                        <button class="support-link" style="width:100%; border:none;" id="pwa-install-btn"><i class="material-icons-round">install_mobile</i> Install App</button>
                    </div>

                    <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 20px;">nitai.grp00@gmail.com</div>
                    <button class="btn-premium" style="background: var(--error); color: #fff;" onclick="app.logout()">Logout Account</button>
                </div>
            </div>
        </div>

        <!-- Floating Navbar -->
        <nav id="navbar" style="display:none;">
            <button class="nav-item active" onclick="app.navigate('dash')"><i class="material-icons-round">dashboard</i><span>Dash</span></button>
            <button class="nav-item" onclick="app.navigate('history')"><i class="material-icons-round">list_alt</i><span>Logs</span></button>
            <button class="nav-item" onclick="app.navigate('add')"><i class="material-icons-round" style="font-size:45px; color:var(--primary); margin-top:-10px">add_circle</i><span>New</span></button>
            <button class="nav-item" onclick="app.navigate('info')"><i class="material-icons-round">support_agent</i><span>Support</span></button>
        </nav>
    </div>

    <script>
        const i18n = {
            en: { welcome: "Verify Account", notice_text: "This application is NOT for trading. It is strictly for personal journal entries and performance calculation. All decisions and risks are the user's responsibility. Nitai Studio is not liable for your trading losses.", total_inv: "Invested", net_pnl: "Net P/L", recent: "Journal Logs", date: "Date", session: "Session", logic: "Logic", symbol: "Symbol", rr: "R:R Ratio", outcome: "Result", bq: "Buy Cost", sq: "Sell Cost", mistake: "Notes", save: "Save Journal", win_rate: "Win Rate", avg_rr: "Avg RR" },
            bn: { welcome: "‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á", notice_text: "‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶®‡ßü‡•§ ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡ßá‡¶∞ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§ ‡¶∏‡¶ï‡¶≤ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶ø‡¶¶‡ßç‡¶ß‡¶æ‡¶®‡ßç‡¶§‡ßá‡¶∞ ‡¶¶‡¶æ‡ßü‡¶≠‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞‡•§ ‡¶®‡¶ø‡¶§‡¶æ‡¶á ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡¶ø‡¶ì ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡¶æ‡ßü‡ßÄ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶®‡¶æ‡•§", total_inv: "‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶®‡¶ø‡ßü‡ßã‡¶ó", net_pnl: "‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠/‡¶ï‡ßç‡¶∑‡¶§‡¶ø", recent: "‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡¶ó", date: "‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ", session: "‡¶∏‡ßá‡¶∂‡¶®", logic: "‡¶≤‡¶ú‡¶ø‡¶ï", symbol: "‡¶∏‡¶ø‡¶Æ‡ßç‡¶¨‡¶≤", rr: "R:R ‡¶∞‡ßá‡¶∂‡¶ø‡¶ì", outcome: "‡¶´‡¶≤‡¶æ‡¶´‡¶≤", bq: "‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø", sq: "‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡ßü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø", mistake: "‡¶®‡ßã‡¶ü‡¶∏", save: "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®", win_rate: "‡¶â‡¶á‡¶® ‡¶∞‡ßá‡¶ü", avg_rr: "‡¶ó‡ßú RR" },
            hi: { welcome: "‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç", notice_text: "‡§Ø‡§π ‡§ê‡§™ ‡§ü‡•ç‡§∞‡•á‡§°‡§ø‡§Ç‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§Ø‡§π ‡§ï‡•á‡§µ‡§≤ ‡§Ü‡§™‡§ï‡•á ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ü‡•ç‡§∞‡•á‡§° ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à‡•§ ‡§∏‡§≠‡•Ä ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä ‡§Ü‡§™‡§ï‡•Ä ‡§π‡•à‡•§ ‡§®‡§ø‡§§‡§æ‡§à ‡§∏‡•ç‡§ü‡•Ç‡§°‡§ø‡§Ø‡•ã ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", total_inv: "‡§ï‡•Å‡§≤ ‡§®‡§ø‡§µ‡•á‡§∂", net_pnl: "‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠/‡§π‡§æ‡§®‡§ø", recent: "‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°", date: "‡§§‡§ø‡§•‡§ø", session: "‡§∏‡§§‡•ç‡§∞", logic: "‡§≤‡•â‡§ú‡§ø‡§ï", symbol: "‡§∏‡§ø‡§Ç‡§¨‡§≤", rr: "R:R ‡§Ö‡§®‡•Å‡§™‡§æ‡§§", outcome: "‡§™‡§∞‡§ø‡§£‡§æ‡§Æ", bq: "‡§ñ‡§∞‡•Ä‡§¶ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø", sq: "‡§µ‡§ø‡§ï‡•ç‡§∞‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø", mistake: "‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä", save: "‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç", win_rate: "‡§ú‡•Ä‡§§ ‡§¶‡§∞", avg_rr: "‡§î‡§∏‡§§ RR" }
        };

        const app = {
            db: null, user: null, lang: 'en', pwa: null,
            init: async function() {
                this.lang = localStorage.getItem('nt_lang_v4') || 'en';
                document.getElementById('app-lang').value = this.lang;
                this.updateLanguage();
                await this.initDB();
                
                // Final Splash Timer and State Check
                setTimeout(() => {
                    document.getElementById('splash').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('splash').style.display = 'none';
                        this.checkAuth();
                    }, 600);
                }, 2500);

                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); this.pwa = e; });
                document.getElementById('pwa-install-btn').onclick = () => { if(this.pwa) this.pwa.prompt(); };
            },
            initDB: function() {
                return new Promise(res => {
                    const req = indexedDB.open("NitaiStudioJournalV4", 1);
                    req.onupgradeneeded = e => e.target.result.createObjectStore("trades", { keyPath: "id", autoIncrement: true });
                    req.onsuccess = e => { this.db = e.target.result; res(); };
                });
            },
            checkAuth: function() {
                const u = localStorage.getItem('nt_user_v4');
                const n = localStorage.getItem('nt_notice_v4');
                if(!u) {
                    document.getElementById('login-overlay').classList.remove('hidden');
                } else if(!n) {
                    this.user = u;
                    document.getElementById('notice-overlay').classList.remove('hidden');
                } else {
                    this.user = u;
                    this.startApp();
                }
            },
            updateLanguage: function() {
                this.lang = document.getElementById('app-lang').value;
                localStorage.setItem('nt_lang_v4', this.lang);
                const t = i18n[this.lang];
                document.getElementById('l-notice-text').innerText = t.notice_text;
                ["win-rate","avg-rr","total-inv","net-pnl","recent-head","date","session","logic","symbol","rr","outcome","bq","sq","mistake","save-btn"].forEach(k => {
                    const el = document.getElementById('l-'+k); if(el) el.innerText = t[k.replace('-','_')] || k;
                });
            },
            doLogin: function() {
                const p = document.getElementById('user-mobile').value.trim();
                if(p.length < 5) return alert("Valid Number Required!");
                localStorage.setItem('nt_user_v4', p);
                this.user = p;
                document.getElementById('login-overlay').classList.add('hidden');
                this.checkAuth();
            },
            acceptNotice: function() {
                localStorage.setItem('nt_notice_v4', 'true');
                document.getElementById('notice-overlay').classList.add('hidden');
                this.startApp();
            },
            startApp: function() {
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('navbar').style.display = 'flex';
                document.getElementById('user-id-tag').innerText = "Nitai Studio Account: " + this.user;
                this.navigate('dash');
            },
            navigate: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('scr-' + id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const map = {dash:0, history:1, add:2, info:3};
                document.querySelectorAll('.nav-item')[map[id]].classList.add('active');
                if(id === 'dash' || id === 'history') this.loadData();
                document.getElementById('main-content').scrollTop = 0;
            },
            saveEntry: function() {
                const sym = document.getElementById('t-symbol').value.toUpperCase().trim();
                if(!sym) return alert("Enter Asset Symbol!");
                const entry = {
                    uid: this.user, date: document.getElementById('t-date').value || new Date().toISOString().split('T')[0],
                    sym: sym, session: document.getElementById('t-session').value,
                    logic: document.getElementById('t-logic').value,
                    rr: parseFloat(document.getElementById('t-rr').value) || 0,
                    outcome: document.getElementById('t-outcome').value,
                    bq: parseFloat(document.getElementById('t-bq').value) || 0,
                    sq: parseFloat(document.getElementById('t-sq').value) || 0,
                    mistake: document.getElementById('t-mistake').value, ts: Date.now()
                };
                const tx = this.db.transaction("trades", "readwrite");
                tx.objectStore("trades").add(entry);
                tx.oncomplete = () => { alert("Saved to Nitai Studio Journal!"); this.navigate('dash'); };
            },
            loadData: function() {
                const tx = this.db.transaction("trades", "readonly");
                const req = tx.objectStore("trades").getAll();
                req.onsuccess = () => {
                    const data = req.result.filter(t => t.uid === this.user).sort((a,b) => b.ts - a.ts);
                    this.render(data);
                };
            },
            render: function(data) {
                const total = data.length;
                const wins = data.filter(t => t.outcome === 'Win').length;
                const totalInv = data.reduce((s, t) => s + t.bq, 0);
                const totalPnl = data.reduce((s, t) => s + (t.sq - t.bq), 0);
                const avgRR = total ? (data.reduce((s, t) => s + t.rr, 0) / total).toFixed(2) : "0.00";

                document.getElementById('d-win').innerText = total ? ((wins/total)*100).toFixed(0) + '%' : '0%';
                document.getElementById('d-rr').innerText = avgRR;
                document.getElementById('d-inv').innerText = "‚Çπ" + totalInv.toLocaleString();
                const pnlEl = document.getElementById('d-pnl');
                pnlEl.innerText = (totalPnl >= 0 ? '+' : '') + "‚Çπ" + totalPnl.toLocaleString();
                pnlEl.style.color = totalPnl >= 0 ? 'var(--success)' : 'var(--error)';

                const itemHTML = (t) => `
                    <div class="log-item" style="border-left-color: ${t.outcome === 'Win' ? 'var(--success)' : 'var(--error)'}">
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div>
                                <div style="font-weight:800; font-size:16px;">${t.sym} <small style="color:var(--primary)">(${t.session})</small></div>
                                <div style="font-size:11px; color:var(--text-dim); margin-top:4px;">${t.date} ‚Ä¢ ${t.logic}</div>
                            </div>
                            <div style="text-align:right">
                                <div style="font-weight:800; color:${t.sq-t.bq >= 0 ? 'var(--success)' : 'var(--error)'}">${t.sq-t.bq >= 0 ? '+' : ''}${(t.sq-t.bq).toFixed(2)}</div>
                                <div style="font-size:10px; color:var(--text-dim)">RR: ${t.rr}</div>
                            </div>
                        </div>
                        ${t.mistake ? `<div style="margin-top:10px; font-size:11px; color:var(--text-dim); background:#000; padding:10px; border-radius:15px; border: 1px solid var(--border)">üìù ${t.mistake}</div>` : ''}
                    </div>`;

                document.getElementById('list-recent').innerHTML = data.slice(0, 5).map(itemHTML).join('');
                document.getElementById('list-history').innerHTML = data.map(itemHTML).join('');
            },
            logout: function() {
                if(confirm("Logout? All data will stay safe on your device locally.")){ localStorage.clear(); window.location.reload(); }
            }
        };

        window.onload = () => { app.init(); document.getElementById('t-date').valueAsDate = new Date(); };

        // PWA Implementation
        if ('serviceWorker' in navigator) {
            const swCode = `self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));`;
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([swCode], {type: 'application/javascript'})));
        }
    </script>
</body>
</html>