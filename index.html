<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TradeTrack Pro | Nitai Studio</title>

    <!-- Firebase Legacy SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <!-- Google Material Icons & Fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --surface: rgba(22, 22, 22, 0.85);
            --primary: #d0bcff;
            --secondary: #b0a1cf;
            --accent: #00f2ff;
            --error: #ff5252;
            --success: #00e676;
            --text: #ffffff;
            --text-dim: #999999;
            --glass-border: rgba(255, 255, 255, 0.12);
            --neon-glow: 0 0 15px rgba(208, 188, 255, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body, html {
            margin: 0; padding: 0;
            background-color: #000;
            color: var(--text);
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- Main Responsive Shell --- */
        .app-shell {
            width: 100%; height: 100%;
            max-width: 480px;
            background: linear-gradient(180deg, #101010 0%, #000000 100%);
            position: relative; display: flex; flex-direction: column; overflow: hidden;
            border-left: 1px solid var(--glass-border);
            border-right: 1px solid var(--glass-border);
        }

        @media screen and (min-width: 600px) {
            .app-shell { height: 94vh; border-radius: 45px; border: 1.5px solid var(--glass-border); box-shadow: 0 0 60px rgba(0,0,0,1); }
        }

        /* --- Scrollable Content Area --- */
        .content-area {
            flex: 1; overflow-y: auto;
            padding-bottom: 110px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .content-area::-webkit-scrollbar { display: none; }

        /* --- UNIQUE ANIMATIONS --- */
        @keyframes logoPulse { 0% { transform: scale(1); filter: drop-shadow(0 0 5px var(--primary)); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 25px var(--primary)); } 100% { transform: scale(1); filter: drop-shadow(0 0 5px var(--primary)); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Splash Screen --- */
        #splash {
            position: absolute; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .logo-box {
            width: 115px; height: 115px; background: #151515; border-radius: 35px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--primary); animation: logoPulse 3s infinite ease-in-out;
        }
        .logo-box i { font-size: 65px; color: var(--primary); }

        /* --- Premium Cards --- */
        .glass-card {
            background: var(--surface); backdrop-filter: blur(25px);
            border-radius: 32px; padding: 25px; margin: 15px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            animation: slideUp 0.6s ease-out;
        }

        /* --- Stats Design --- */
        .periodic-summary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 0 15px 15px 15px; }
        .p-stat { background: rgba(255,255,255,0.03); padding: 14px 10px; border-radius: 24px; text-align: center; border: 1px solid var(--glass-border); }
        .p-stat small { font-size: 9px; color: var(--text-dim); display: block; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; }
        .p-stat div { font-size: 14px; font-weight: 800; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 0 15px; }
        .stat-box { background: #111; padding: 22px; border-radius: 30px; border: 1.5px solid var(--glass-border); position: relative; overflow: hidden; }
        .stat-box::after { content:''; position:absolute; top:0; left:0; width:100%; height:4px; background: var(--primary); }

        /* --- Form Elements --- */
        .btn-neon {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #000; border: none; padding: 18px; border-radius: 22px;
            font-weight: 800; cursor: pointer; width: 100%; display: flex;
            align-items: center; justify-content: center; gap: 10px; font-size: 15px;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
            box-shadow: var(--neon-glow);
        }
        .btn-neon:active { transform: scale(0.95); opacity: 0.8; }

        input, select, textarea {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            padding: 16px; border-radius: 18px; color: #fff; margin-bottom: 12px; font-size: 16px;
            transition: 0.3s;
        }
        input:focus { border-color: var(--accent); background: rgba(255,255,255,0.08); }
        label { display: block; font-size: 11px; color: var(--primary); margin: 0 0 6px 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Floating Navigation --- */
        nav {
            position: absolute; bottom: 25px; left: 15px; right: 15px; height: 80px;
            background: rgba(25, 25, 25, 0.8); backdrop-filter: blur(30px);
            display: flex; justify-content: space-around; align-items: center;
            border-radius: 30px; border: 1px solid var(--glass-border); z-index: 999;
            box-shadow: 0 20px 40px rgba(0,0,0,0.8);
        }
        .nav-item { background: none; border: none; color: var(--text-dim); display: flex; flex-direction: column; align-items: center; flex: 1; cursor: pointer; font-weight: 800; font-size: 10px; transition: 0.3s; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 30px; margin-bottom: 2px; transition: 0.3s; }
        .nav-item.active i { transform: translateY(-6px) scale(1.15); text-shadow: 0 0 15px var(--accent); }

        /* --- Overlays --- */
        .overlay { position: absolute; inset: 0; background: #000; z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 25px; animation: fadeIn 0.4s ease; }
        .modal { background: #0a0a0a; padding: 35px; border-radius: 45px; width: 100%; border: 1px solid var(--glass-border); text-align: center; }

        .screen { display: none; }
        .screen.active { display: block; animation: slideUp 0.5s ease-out; }
        .hidden { display: none !important; }

        .journal-log { background: rgba(255,255,255,0.02); border-radius: 28px; padding: 20px; margin: 12px 15px; border-left: 6px solid #222; }

        header { padding: 45px 25px 15px 25px; }
        h1 { font-size: 30px; font-weight: 800; margin: 0; letter-spacing: -1px; }

        .support-card { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 16px; border-radius: 20px; background: #111; border: 1px solid var(--glass-border); text-decoration: none; color: #fff; font-size: 12px; font-weight: 800; margin-top: 12px; }
    </style>
</head>
<body>

    <div class="app-shell">
        <!-- Animated Splash Screen -->
        <div id="splash">
            <div class="logo-box"><i class="material-icons-round">query_stats</i></div>
            <h2 style="margin:25px 0 5px 0; letter-spacing:1px; font-weight:800;">TradeTrack Pro</h2>
            <p style="color:var(--primary); font-weight:800; letter-spacing:3px; font-size:12px;">NITAI STUDIO</p>
        </div>

        <!-- Restoration Login with Country Picker -->
        <div id="login-overlay" class="overlay hidden">
            <div class="modal">
                <div class="logo-box" style="width:80px; height:80px; margin: 0 auto 20px auto; border-radius:24px;"><i class="material-icons-round">cloud_sync</i></div>
                <h2 style="margin:0 0 5px 0">Cloud Sync</h2>
                <p style="font-size:12px; color:var(--text-dim); margin-bottom:25px;">Select country & number to restore your data.</p>
                
                <label>Language</label>
                <select id="app-lang" onchange="app.updateLanguage()">
                    <option value="en">English (Global)</option>
                    <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (BD/India)</option>
                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (India)</option>
                </select>

                <label>Country</label>
                <select id="user-country">
                    <option value="+91">üáÆüá≥ India (+91)</option>
                    <option value="+880">üáßüá© Bangladesh (+880)</option>
                    <option value="+1">üá∫üá∏ USA (+1)</option>
                    <option value="+44">üá¨üáß UK (+44)</option>
                </select>

                <label>Mobile Number</label>
                <input type="tel" id="user-mobile" placeholder="9876543210" maxlength="10">
                
                <button class="btn-neon" style="margin-top:10px;" onclick="app.doLogin()">Restore Data</button>
            </div>
        </div>

        <!-- Disclaimer -->
        <div id="notice-overlay" class="overlay hidden">
            <div class="modal">
                <h2 style="color:var(--error); margin:0">IMPORTANT</h2>
                <div style="max-height:45vh; overflow-y:auto; text-align:left; padding:15px; margin-top:15px; font-size:14px; color:var(--text-dim); line-height:1.7;" id="l-notice-text"></div>
                <button class="btn-neon" style="margin-top:20px" onclick="app.acceptNotice()">I UNDERSTAND</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area" id="main-content" style="display:none;">
            <header>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1 id="screen-title">Journal</h1>
                    <div style="width:50px; height:50px; background:var(--surface); border-radius:18px; display:flex; align-items:center; justify-content:center; border:1px solid var(--glass-border);" onclick="app.navigate('info')">
                        <i class="material-icons-round" style="color:var(--primary); font-size:28px;">person</i>
                    </div>
                </div>
                <div id="user-id-tag" style="font-size:11px; color:var(--accent); font-weight:800; margin-top:8px; text-transform:uppercase;"></div>
            </header>

            <!-- Dash Screen with Periodic Stats -->
            <div id="scr-dash" class="screen">
                <div class="periodic-summary">
                    <div class="p-stat"><small id="l-today">Today</small><div id="d-today">‚Çπ0</div></div>
                    <div class="p-stat"><small id="l-weekly">Weekly</small><div id="d-weekly">‚Çπ0</div></div>
                    <div class="p-stat"><small id="l-monthly">Monthly</small><div id="d-monthly">‚Çπ0</div></div>
                </div>

                <div class="stat-grid">
                    <div class="stat-box" style="border-bottom-color:var(--neon-blue);"><small id="l-win-rate">Win Rate</small><div style="font-size:28px; font-weight:800; color:var(--accent); margin-top:5px;" id="d-win">0%</div></div>
                    <div class="stat-box" style="border-bottom-color:var(--primary);"><small id="l-avg-rr">Avg RR</small><div style="font-size:28px; font-weight:800; margin-top:5px;" id="d-rr">0.00</div></div>
                </div>

                <div class="stat-grid" style="margin-top:15px">
                    <div class="stat-box" style="border-bottom-color:#555;"><small id="l-total-inv">Total Invest</small><div style="font-size:20px; font-weight:800; margin-top:5px;" id="d-inv">‚Çπ0</div></div>
                    <div class="stat-box" style="border-bottom-color:var(--error);"><small id="l-net-pnl">Overall P/L</small><div style="font-size:20px; font-weight:800; margin-top:5px;" id="d-pnl">‚Çπ0</div></div>
                </div>

                <div style="padding:35px 25px 10px 25px;"><h3 id="l-recent-head" style="margin:0; font-size:20px;">Recent Entries</h3></div>
                <div id="list-recent"></div>
            </div>

            <!-- Add Entry Screen -->
            <div id="scr-add" class="screen">
                <div class="glass-card">
                    <label id="l-date">Trade Date</label>
                    <input type="date" id="t-date">
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                        <div>
                            <label id="l-session">Session</label>
                            <select id="t-session">
                                <option value="London">London üá¨üáß</option>
                                <option value="NY">New York üá∫üá∏</option>
                                <option value="Asia">Asia üáØüáµ</option>
                                <option value="India">India üáÆüá≥</option>
                            </select>
                        </div>
                        <div>
                            <label id="l-logic">Trade Logic</label>
                            <select id="t-logic">
                                <option value="Breakout">Breakout</option>
                                <option value="Trend">Trend Follow</option>
                                <option value="S/R">Supp/Resist</option>
                            </select>
                        </div>
                    </div>

                    <label id="l-symbol">Asset Symbol</label>
                    <input type="text" id="t-symbol" placeholder="BTC, NIFTY, GOLD">

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                        <div><label id="l-rr">R:R Ratio</label><input type="number" step="0.1" id="t-rr" placeholder="1.5"></div>
                        <div>
                            <label id="l-outcome">Trade Result</label>
                            <select id="t-outcome">
                                <option value="Win">PROFIT (Win)</option>
                                <option value="Loss">LOSS (Loss)</option>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                        <div><label id="l-bq">Buying Value</label><input type="number" id="t-bq" placeholder="0"></div>
                        <div><label id="l-sq">Selling Value</label><input type="number" id="t-sq" placeholder="0"></div>
                    </div>

                    <label id="l-mistake">Notes / Mistakes</label>
                    <textarea id="t-mistake" rows="3" placeholder="What happened in this trade?"></textarea>

                    <button class="btn-neon" style="margin-top:20px" onclick="app.saveEntry()" id="l-save-btn">Sync to Journal</button>
                </div>
            </div>

            <!-- Full History Screen -->
            <div id="scr-history" class="screen"><div id="list-history"></div></div>

            <!-- Support & Profile Screen -->
            <div id="scr-info" class="screen">
                <div class="glass-card" style="text-align:center;">
                    <div class="logo-box" style="width:85px; height:85px; margin: 0 auto 20px auto; border-radius:24px;"><i class="material-icons-round">person</i></div>
                    <h2 style="margin:0; color:var(--primary);">NITAI STUDIO</h2>
                    <p style="font-size:14px; color:var(--text-dim);">Global Cloud-Sync Journal</p>
                    
                    <div style="margin:25px 0;">
                        <p style="font-size:11px; font-weight:800; color:var(--accent); text-transform:uppercase;">Donate & Support</p>
                        <a href="https://buymeacoffee.com/nitaigrp00a" class="support-card"><i class="material-icons-round">coffee</i> Buy Me a Coffee</a>
                        <a href="https://ko-fi.com/nitaisarkar" class="support-card"><i class="material-icons-round">favorite</i> Ko-fi Support</a>
                        <a href="https://www.patreon.com/cw/NitaiStudio" class="support-card"><i class="material-icons-round">stars</i> Patreon Support</a>
                        <button class="support-card" style="width:100%; border:none; cursor:pointer;" onclick="app.installPWA()"><i class="material-icons-round">download</i> Install Pro App</button>
                    </div>

                    <div style="font-size:12px; color:var(--text-dim); margin-bottom:20px;">nitai.grp00@gmail.com</div>
                    <button class="btn-neon" style="background:var(--error); color:#fff;" onclick="app.logout()">Logout My Account</button>
                </div>
            </div>
        </div>

        <!-- Floating Premium Navigation Bar -->
        <nav id="navbar" style="display:none;">
            <button class="nav-item active" onclick="app.navigate('dash')"><i class="material-icons-round">dashboard</i><span id="n-dash">Home</span></button>
            <button class="nav-item" onclick="app.navigate('history')"><i class="material-icons-round">list_alt</i><span id="n-history">Logs</span></button>
            <button class="nav-item" onclick="app.navigate('add')"><i class="material-icons-round" style="font-size:45px; color:var(--primary); margin-top:-10px">add_circle</i><span id="n-add">New</span></button>
            <button class="nav-item" onclick="app.navigate('info')"><i class="material-icons-round">support_agent</i><span id="n-info">Support</span></button>
        </nav>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG (‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®) ---
        const firebaseConfig = {
  apiKey: "AIzaSyBXAYmNjcXXUqbkNFdzVa6TbxotPH9PcNM",
  authDomain: "trade-track-pro-cd6a7.firebaseapp.com",
  databaseURL: "https://trade-track-pro-cd6a7-default-rtdb.firebaseio.com",
  projectId: "trade-track-pro-cd6a7",
  storageBucket: "trade-track-pro-cd6a7.firebasestorage.app",
  messagingSenderId: "791775076216",
  appId: "1:791775076216:web:c79cefc9bae267bb4a328d"
};
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. MULTI-LANGUAGE DATA ---
        const i18n = {
            en: { notice: "This app is NOT for real trading. It is strictly for performance calculation and personal record. Nitai Studio is not liable for your losses.", today: "Today", weekly: "Weekly", monthly: "Monthly", win_rate: "Win Rate", avg_rr: "Avg RR", total_inv: "Total Invest", net_pnl: "Overall P/L", recent_head: "Recent Entries", save_btn: "Sync to Journal" },
            bn: { notice: "‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡ßü‡•§ ‡¶è‡¶ü‡¶ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶ü‡ßç‡¶∞‡ßá‡¶° ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßç‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶≤‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶ø‡¶§‡¶æ‡¶á ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡¶ø‡¶ì ‡¶¶‡¶æ‡ßü‡ßÄ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá ‡¶®‡¶æ‡•§", today: "‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞", weekly: "‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï", monthly: "‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï", win_rate: "‡¶â‡¶á‡¶® ‡¶∞‡ßá‡¶ü", avg_rr: "‡¶ó‡ßú RR", total_inv: "‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶®‡¶ø‡ßü‡ßã‡¶ó", net_pnl: "‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü ‡¶≤‡¶æ‡¶≠", recent_head: "‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ï ‡¶≤‡¶ó", save_btn: "‡¶ú‡¶æ‡¶∞‡ßç‡¶®‡¶æ‡¶≤‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®" },
            hi: { notice: "‡§Ø‡§π ‡§ê‡§™ ‡§ï‡•á‡§µ‡§≤ ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§ú‡§∞‡•ç‡§®‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•à‡•§ ‡§®‡§ø‡§∞‡•ç‡§£‡§Ø ‡§Ü‡§™‡§ï‡•Ä ‡§Ö‡§™‡§®‡•Ä ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞‡•Ä ‡§π‡•à‡•§ ‡§®‡§ø‡§§‡§æ‡§à ‡§∏‡•ç‡§ü‡•Ç‡§°‡§ø‡§Ø‡•ã ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§®‡•Å‡§ï‡§∏‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§ø‡§Æ‡•ç‡§Æ‡•á‡§¶‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", today: "‡§Ü‡§ú", weekly: "‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï", monthly: "‡§Æ‡§æ‡§∏‡§ø‡§ï", win_rate: "‡§ú‡•Ä‡§§ ‡§¶‡§∞", avg_rr: "‡§î‡§∏‡§§ RR", total_inv: "‡§ï‡•Å‡§≤ ‡§®‡§ø‡§µ‡•á‡§∂", net_pnl: "‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§≠", recent_head: "‡§π‡§æ‡§≤ ‡§ï‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°", save_btn: "‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç" }
        };

        const app = {
            user: null, lang: 'en', trades: [], deferredPrompt: null,
            init: async function() {
                this.lang = localStorage.getItem('nt_lang_v7') || 'en';
                document.getElementById('app-lang').value = this.lang;
                this.updateLanguage();
                this.setupPWA();

                setTimeout(() => {
                    document.getElementById('splash').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('splash').style.display = 'none';
                        this.checkAuth();
                    }, 600);
                }, 2500);
            },
            setupPWA: function() {
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); this.deferredPrompt = e; });
            },
            installPWA: function() {
                if(this.deferredPrompt) { this.deferredPrompt.prompt(); this.deferredPrompt = null; }
                else alert("App is already installed or browser not supported.");
            },
            checkAuth: function() {
                const u = localStorage.getItem('nt_user_v7');
                const n = localStorage.getItem('nt_notice_v7');
                if(!u) document.getElementById('login-overlay').classList.remove('hidden');
                else if(!n) { this.user = u; document.getElementById('notice-overlay').classList.remove('hidden'); }
                else { this.user = u; this.startApp(); }
            },
            updateLanguage: function() {
                this.lang = document.getElementById('app-lang').value;
                localStorage.setItem('nt_lang_v7', this.lang);
                const t = i18n[this.lang];
                document.getElementById('l-notice-text').innerText = t.notice;
                ["today","weekly","monthly","win-rate","avg-rr","total-inv","net-pnl","recent-head","save-btn"].forEach(k => {
                    const el = document.getElementById('l-'+k); if(el) el.innerText = t[k.replace('-','_')];
                });
            },
            doLogin: function() {
                const c = document.getElementById('user-country').value;
                const p = document.getElementById('user-mobile').value.trim();
                if(p.length !== 10) return alert("Enter 10-digit number");
                const fullId = c + p;
                localStorage.setItem('nt_user_v7', fullId);
                this.user = fullId;
                document.getElementById('login-overlay').classList.add('hidden');
                this.checkAuth();
            },
            acceptNotice: function() {
                localStorage.setItem('nt_notice_v7', 'true');
                document.getElementById('notice-overlay').classList.add('hidden');
                this.startApp();
            },
            startApp: function() {
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('navbar').style.display = 'flex';
                document.getElementById('user-id-tag').innerText = "Nitai Cloud Active: " + this.user;
                this.navigate('dash');
            },
            navigate: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('scr-' + id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                const map = {dash:0, history:1, add:2, info:3};
                document.querySelectorAll('.nav-item')[map[id]].classList.add('active');
                this.fetchData();
            },
            fetchData: function() {
                db.ref('nt_users_v7/' + this.user + '/trades').on('value', (snap) => {
                    const data = snap.val();
                    this.trades = data ? Object.values(data).sort((a,b) => b.ts - a.ts) : [];
                    this.render();
                });
            },
            saveEntry: function() {
                const sym = document.getElementById('t-symbol').value.toUpperCase().trim();
                if(!sym) return alert("Asset Name Required!");
                const entry = {
                    date: document.getElementById('t-date').value || new Date().toISOString().split('T')[0],
                    sym: sym, session: document.getElementById('t-session').value,
                    logic: document.getElementById('t-logic').value,
                    rr: parseFloat(document.getElementById('t-rr').value) || 0,
                    outcome: document.getElementById('t-outcome').value,
                    bq: parseFloat(document.getElementById('t-bq').value) || 0,
                    sq: parseFloat(document.getElementById('t-sq').value) || 0,
                    mistake: document.getElementById('t-mistake').value, ts: Date.now()
                };
                db.ref('nt_users_v7/' + this.user + '/trades').push(entry).then(() => {
                    alert("Synced Successfully!"); this.navigate('dash');
                });
            },
            render: function() {
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay())).toISOString().split('T')[0];
                const monthStart = todayStr.substring(0, 7) + "-01";

                let dayPnl = 0, weekPnl = 0, monthPnl = 0, totalPnl = 0, totalInv = 0, totalRR = 0;
                this.trades.forEach(t => {
                    const pnl = t.sq - t.bq;
                    totalPnl += pnl; totalInv += t.bq; totalRR += t.rr;
                    if(t.date === todayStr) dayPnl += pnl;
                    if(t.date >= weekStart) weekPnl += pnl;
                    if(t.date >= monthStart) monthPnl += pnl;
                });

                const wins = this.trades.filter(t => t.outcome === 'Win').length;
                const total = this.trades.length;

                const colorEl = (val, id) => {
                    const el = document.getElementById(id);
                    el.innerText = (val>=0?'+':'') + "‚Çπ" + val.toLocaleString();
                    el.style.color = val>=0?'var(--success)':'var(--error)';
                };

                colorEl(dayPnl, 'd-today'); colorEl(weekPnl, 'd-weekly'); colorEl(monthPnl, 'd-monthly');
                colorEl(totalPnl, 'd-pnl');
                document.getElementById('d-inv').innerText = "‚Çπ" + totalInv.toLocaleString();
                document.getElementById('d-win').innerText = total ? ((wins/total)*100).toFixed(0) + "%" : "0%";
                document.getElementById('d-rr').innerText = total ? (totalRR/total).toFixed(2) : "0.00";

                const logHTML = (t) => `
                    <div class="journal-log" style="border-left-color:${t.outcome === 'Win'?'var(--success)':'var(--error)'}">
                        <div style="display:flex; justify-content:space-between;">
                            <div><b>${t.sym}</b><br><small style="color:var(--text-dim)">${t.date} ‚Ä¢ ${t.logic}</small></div>
                            <div style="text-align:right">
                                <b style="color:${t.sq-t.bq>=0?'var(--success)':'var(--error)'}">${(t.sq-t.bq).toFixed(2)}</b><br>
                                <small style="color:var(--text-dim)">RR ${t.rr}</small>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('list-recent').innerHTML = this.trades.slice(0,5).map(logHTML).join('');
                document.getElementById('list-history').innerHTML = this.trades.map(logHTML).join('');
            },
            logout: function() { if(confirm("Logout? Data stays safe in Cloud.")){ localStorage.clear(); window.location.reload(); } }
        };

        window.onload = () => { app.init(); document.getElementById('t-date').valueAsDate = new Date(); };

        // --- PWA MANIFEST & SW ---
        const manifest = { "name": "TradeTrack Pro", "short_name": "T-Track", "start_url": ".", "display": "standalone", "background_color": "#000000", "theme_color": "#000000", "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/2422/2422796.png", "sizes": "512x512", "type": "image/png" }] };
        const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'}); document.getElementById('pwa-manifest').href = URL.createObjectURL(mBlob);
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register(URL.createObjectURL(new Blob([`self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))))`], {type:'application/javascript'}))); }
    </script>
</body>
</html>